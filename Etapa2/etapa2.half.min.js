function shuffle(t){
	for(var i,e,s=t.length;s;)
		e=Math.floor(Math.random()*s--),i=t[s],t[s]=t[e],t[e]=i;
	return t
}
function readSingleFile(t){
	var i=t.target.files[0];
	if(i){
		var e=new FileReader;
		e.onload=function(t){
			var i=t.target.result;
			kibus.cargarMapa(JSON.parse(i))
		},e.readAsText(i)
	}else 
		alert("Failed to load file")
}
!function(){
	for(var t=0,i=["ms","moz","webkit","o"],e=0;e<i.length&&!window.requestAnimationFrame;++e)
		window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];
	window.requestAnimationFrame||(window.requestAnimationFrame=function(i,e){
		var s=(new Date).getTime(),h=Math.max(0,16-(s-t)),a=window.setTimeout(function(){i(s+h)},h);
		return t=s+h,a
	}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),Function.prototype.bind||(Function.prototype.bind=function(t){
		if("function"!=typeof this)
			throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");
		var i=Array.prototype.slice.call(arguments,1),e=this,s=function(){},h=function(){
			return e.apply(this instanceof s&&t?this:t,i.concat(Array.prototype.slice.call(arguments)))
		};
		return s.prototype=this.prototype,h.prototype=new s,h
	})
}(),document.getElementById("fileinput").addEventListener("change",readSingleFile,!1);
var Kibus=function(t,i,e){
	this.canvas=t;
	var s=this,h=function(t){
		if(s.editable){
			var i=~~(t.layerX/s.tileWidth),e=~~(t.layerY/s.tileHeight);
			if(s.option=+s.option,i>=0&&e>=0&&i<s.mapWidth&&e<s.mapHeight)
				switch(s.option){
					case 0:case 1:
						1==t.buttons&&(s.character.x==i&&s.character.y==e||s.house.x==i&&s.house.y==e||(s.map[e][i]=s.option,s.draw(i,e)));
					break;
					case 2:
						if(1==t.buttons&&1!=s.map[e][i]){
							var h=s.house.x,a=s.house.y;
							s.house.x=i,s.house.y=e,s.draw(h,a),s.drawEntity(s.house),s.drawEntity(s.character)
						}
					break;
					case 3:
						if(1==t.buttons&&1!=s.map[e][i]){
							var h=s.character.x,a=s.character.y;
							s.character.x=i,s.character.y=e,s.draw(h,a),s.drawEntity(s.house),s.drawEntity(s.character)
						}
				}
		}
	};
	this.canvas.addEventListener("mousedown",h),this.canvas.addEventListener("mousemove",h),window.addEventListener("keydown",function(t){
		switch(t.keyCode){
			case 82:
				s.retornar()
		}
	}),this.ctx=t.getContext("2d"),this.mapWidth=i,this.mapHeight=e,s.movesX=[-1,-1,0,1,1,1,0,-1],s.movesY=[0,-1,-1,-1,0,1,1,1],this.editable=!0,this.prevPosition={x:null,y:null},this.putOptions={Terreno:0,"Obstáculo":1,Casa:2,Kibus:3},this.option=0,this.percentage=25,this.map=null,this.tileWidth=~~(this.canvas.width/this.mapWidth),this.tileHeight=~~(this.canvas.height/this.mapHeight),this.fps=5,this.flagLimit=10,this.images=Array(),this.grassImage=document.createElement("img"),this.grassImage.src="../src/assets/grass.png",this.images.push(this.grassImage),this.rockImage=document.createElement("img"),this.rockImage.src="../src/assets/tree.png",this.images.push(this.rockImage);
	var a=function(t,i,e,h){
		this.x=t,this.y=i,this.type=e,this.image=null,this.orientation=null,h&&("object"==typeof h?(this.images={},this.images.u=document.createElement("img"),this.images.u.src=h.u.src,s.images.push(this.images.u),this.images.u.actualStep=0,this.images.u.steps=h.u.steps,this.images.u.width=h.u.width,this.images.u.height=h.u.height,this.images.d=document.createElement("img"),this.images.d.src=h.d.src,s.images.push(this.images.d),this.images.d.actualStep=0,this.images.d.steps=h.d.steps,this.images.d.width=h.d.width,this.images.d.height=h.d.height,this.images.l=document.createElement("img"),this.images.l.src=h.l.src,s.images.push(this.images.l),this.images.l.actualStep=0,this.images.l.steps=h.l.steps,this.images.l.width=h.l.width,this.images.l.height=h.l.height,this.images.r=document.createElement("img"),this.images.r.src=h.r.src,s.images.push(this.images.r),this.images.r.actualStep=0,this.images.r.steps=h.r.steps,this.images.r.width=h.r.width,this.images.r.height=h.r.height,this.orientation="d"):(this.image=document.createElement("img"),this.image.src=h,s.images.push(this.image)))
	};
	this.character=new a(0,0,0,{
		d:{src:"../src/assets/linkD.png",steps:7,width:16,height:24},
		u:{src:"../src/assets/linkD.png",steps:7,width:16,height:24},
		l:{src:"../src/assets/linkD.png",steps:7,width:16,height:24},
		r:{src:"../src/assets/linkD.png",steps:7,width:16,height:24}
	}),this.house=new a(0,0,1,"../src/assets/houseTLOZ.png"),this.animationId=null,this.enCasa=!1,this.pilaMovimientos=[]
};
Kibus.prototype.draw=function(t,i){
	var e=null;
	0==this.map[i][t]?(e=this.grassImage,this.ctx.drawImage(e,0,0,16,16,t*this.tileWidth,i*this.tileHeight,this.tileWidth,this.tileHeight)):1==this.map[i][t]&&(e=this.rockImage,this.ctx.drawImage(e,0,0,64,80,t*this.tileWidth,i*this.tileHeight,this.tileWidth,this.tileHeight)),this.flagsMap[i][t]&&(this.ctx.beginPath(),this.ctx.moveTo(t*this.tileWidth+this.tileWidth/4,i*this.tileHeight+this.tileHeight-1),this.ctx.lineTo(t*this.tileWidth+3*this.tileWidth/4,i*this.tileHeight+this.tileHeight-1),this.ctx.moveTo(t*this.tileWidth+this.tileWidth/2,i*this.tileHeight+this.tileHeight-1),this.ctx.lineTo(t*this.tileWidth+this.tileWidth/2,i*this.tileHeight+this.tileHeight/10),this.ctx.lineTo(t*this.tileWidth+1,i*this.tileHeight+this.tileHeight/4),this.ctx.lineTo(t*this.tileWidth+this.tileWidth/2,i*this.tileHeight+this.tileHeight/1.8),this.ctx.closePath(),this.ctx.fillStyle="hsl(15, 100%, "+(80-4*this.flagsMap[i][t])+"%)",this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="blue",this.ctx.font="8px",this.ctx.fillText(this.flagsMap[i][t],t*this.tileWidth+this.tileWidth/4.2,i*this.tileHeight+this.tileHeight/2.5))
},Kibus.prototype.drawEntity=function(t){
	if(0==t.type){
		if(this.ctx.fillStyle="blue",t.orientation)
			switch(t.orientation){
				case"d":
					this.ctx.drawImage(t.images.d,t.images.d.actualStep*t.images.d.width,0,t.images.d.width,t.images.d.height,t.x*this.tileWidth,t.y*this.tileHeight,this.tileWidth,this.tileHeight),t.images.d.actualStep=(t.images.d.actualStep+1)%t.images.d.steps
			}
	}else 
		1==t.type&&this.ctx.drawImage(t.image,0,0,64,94,t.x*this.tileWidth,t.y*this.tileHeight,this.tileWidth,this.tileHeight)
},Kibus.prototype.render=function(){
	this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
	for(var t=this.mapHeight-1;t>=0;t--)
		for(var i=this.mapWidth-1;i>=0;i--)
			this.draw(i,t);
	this.drawEntity(this.house),this.drawEntity(this.character)
},Kibus.prototype.initFlags=function(){
	for(var t=0;t<this.mapHeight;t++)
		for(var i=0;i<this.mapWidth;i++)
			this.flagsMap[t][i]=0
},Kibus.prototype.makeRandomMap=function(t){
	var i=t>100?100:0>t?0:t;
	i/=100;
	for(var e=~~(this.mapWidth*this.mapHeight*i),s=!1,h=Array(this.mapWidth*this.mapHeight),a=0;e>a;a++)
		h[a]=1;
	for(var a=e,r=h.length;r>a;a++)
		h[a]=0;
	shuffle(h);
	for(var a=0;a<this.mapHeight;a++)
		for(var r=0;r<this.mapWidth;r++)
			this.map[a][r]=h[a*this.mapWidth+r],0!=this.map[a][r]||s||(this.house.x=r,this.house.y=a,this.character.x=r,this.character.y=a,s=!0)
},Kibus.prototype.estaEnCasa=function(){
	this.character.x==this.house.x&&this.character.y==this.house.y?this.enCasa=!0:this.enCasa=!1
},Kibus.prototype.canMove=function(){
	for(var t,i,e=this,s=[],h=e.character.x,a=e.character.y,r=0;8>r;r++)
		t=h+e.movesX[r],i=a+e.movesY[r],s.push(t>=0&&i>=0&&t<e.mapWidth&&i<e.mapHeight&&1!=e.map[i][t]?!0:!1);
	return s
},Kibus.prototype.getProbabilities=function(){
	for(var t=this,i=[],e=this.canMove(),s=0,h=0;8>h;h++){
		var a=e[h]?this.flagsMap[this.character.y+t.movesY[h]][this.character.x+t.movesX[h]]+1:0;
		this.character.x+t.movesX[h]==this.prevPosition.x&&this.character.y+t.movesY[h]==this.prevPosition.y?e[h]?i[h]=1/(a*a*a*a):i[h]=0:e[h]?i[h]=1/(a*a):i[h]=0,s+=i[h]
	}
	for(var r=[],n=0,h=0;8>h;h++)
		i[h]?(n+=i[h]/s,r[h]=n):r[h]=n;
	return r
},Kibus.prototype.getRandomMovement=function(){
	for(var t=this.getProbabilities(),i=Math.random(),e=0;e<t.length;e++)
		if(i<=t[e])
			return e;
	return null
},Kibus.prototype.makeRandomMovement=function(){
	var t=this.getRandomMovement();
	return null==t?void alert("Se quedó sin movimientos"):(this.prevPosition.x=this.character.x,this.prevPosition.y=this.character.y,this.character.x+=this.movesX[t],this.character.y+=this.movesY[t],this.flagsMap[this.prevPosition.y][this.prevPosition.x]++,this.draw(this.prevPosition.x,this.prevPosition.y),this.draw(this.character.x,this.character.y),void this.drawEntity(this.character))
},Kibus.prototype.validPoint=function(t,i){
	return t>=0&&i>=0&&t<this.mapWidth&&i<this.mapHeight&&1!=this.map[i][t]&&this.flagsMap[i][t]<=this.flagLimit?!0:!1
},Kibus.prototype.getLine=function(t,i,e,s){
	var h,a,r,n,o,c,m,l,p,g=[];
	if(r=e-t,n=s-i,0>n?(n=-n,p=-1):p=1,0>r?(r=-r,l=-1):l=1,h=t,a=i,r>n)
		for(o=2*n-r,c=2*n,m=2*(n-r);h!=e;){
			if(h+=l,0>o?o+=c:(a+=p,o+=m),!this.validPoint(h,a))
				return g;
			g.push({x:h,y:a})
		}
	else 
		for(o=2*r-n,c=2*r,m=2*(r-n);a!=s;){
			if(a+=p,0>o?o+=c:(h+=l,o+=m),!this.validPoint(h,a))
				return g;
			g.push({x:h,y:a})
		}
	return g
},Kibus.prototype._retornar=function(){
	var t=this;
	setTimeout(function(){
		if(t.enCasa)
			cancelAnimationFrame(t.animationId);
		else 
			if(t.animationId=requestAnimationFrame(t._retornar.bind(t)),0==t.pilaMovimientos.length&&(t.pilaMovimientos=t.getLine(t.character.x,t.character.y,t.house.x,t.house.y),0==t.pilaMovimientos.length&&t.makeRandomMovement()),t.pilaMovimientos.length){
				var i=t.pilaMovimientos.shift();
				t.prevPosition.x=t.character.x,t.prevPosition.y=t.character.y,t.character.x=i.x,t.character.y=i.y,t.draw(t.prevPosition.x,t.prevPosition.y),t.drawEntity(t.character),t.character.x==t.house.x&&t.character.y==t.house.y&&(t.enCasa=!0)
			}
	},1e3/t.fps)
},Kibus.prototype.retornar=function(){
	this.initFlags(),this.animationId=requestAnimationFrame(this._retornar.bind(this))
},Kibus.prototype.onLoad=function(t){
	for(var i=this.images.length,e=0,s=this,h=0;i>h;h++)
		this.images[h].onload=function(){
			++e>=i&&t.call(s)
		}
},Kibus.prototype.init=function(){
	this.map=Array(this.mapHeight),this.flagsMap=Array(this.mapHeight);
	for(var t=this.mapHeight-1;t>=0;t--)
		this.map[t]=Array(this.mapWidth),this.flagsMap[t]=Array(this.mapWidth);
	this.initFlags(),this.tileWidth=~~(this.canvas.width/this.mapWidth),this.tileHeight=~~(this.canvas.height/this.mapHeight),this.makeRandomMap(this.percentage),this.enCasa=!1,this.render()
},Kibus.prototype.download=function(){
	for(var t=document.createElement("a"),i='{"width": '+this.mapWidth+', "height": '+this.mapHeight+', "map":[',e=0;e<this.map.length;e++){
		i+="[";
		for(var s=0;s<this.map[0].length;s++)
			i+=this.map[e][s],s<this.map[0].length-1&&(i+=",");
		i+="]",e<this.map.length-1&&(i+=",")
	}
	i+="]}",t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(i)),t.setAttribute("download","mundo.kib"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)
},Kibus.prototype.upload=function(){
	document.getElementById("fileinput").click()
},Kibus.prototype.cargarMapa=function(t){
	this.mapWidth=t.width,this.mapHeight=t.height,this.map=Array(t.height),this.flagsMap=Array(t.height);
	for(var i=t.width-1;i>=0;i--)
		this.map[i]=Array(t.width),this.flagsMap[i]=Array(t.width);
	this.initFlags(),this.tileWidth=~~(this.canvas.width/this.mapWidth),this.tileHeight=~~(this.canvas.height/this.mapHeight);
	for(var e=!1,i=0;i<this.mapHeight;i++)
		for(var s=0;s<this.mapWidth;s++)
			this.map[i][s]=t.map[i][s],0!=this.map[i][s]||e||(this.house.x=s,this.house.y=i,this.character.x=s,this.character.y=i,e=!0);
	this.enCasa=!1,this.render()
};